<!DOCTYPE html>
<html>
	<title>Upload and return image test</title>
	<head>
		<link rel="stylesheet" href="../static/css/style.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

	</head>
	<body>
		<h2>Select Gastric X-ray images to upload and display heatmap</h2>
		<p>
			{% with messages = get_flashed_messages() %}
	  			{% if messages %}
					<ul class=flashes>
						{% for message in messages %}
		  				<li>{{ message }}</li>
						{% endfor %}
					</ul>
	  			{% endif %}
			{% endwith %}
		</p>

		<form method="post" action="/" enctype="multipart/form-data">
    		<dl>
				<p>
					<!--<input class="waves-effect waves-light btn" type="file" name="files[]" multiple="true" autocomplete="off" required>-->
					<div class="file-field input-field">
						<div class="btn waves-effect waves-light">
						  <span>Choose Files</span>
						  <input type="file" name="files[]" multiple required>
						</div>
						<div class="file-path-wrapper">
						  <input class="file-path validate" type="text" style="width: 300px; max-width: 100%;" placeholder="Upload one or more files" readonly autocomplete="off">
						</div>
					  </div>
				</p>
    		</dl>
    		<p>
				<!--<input class="btn waves-effect waves-light" type="submit" value="Submit">-->
				<button class="btn waves-effect waves-light" type="submit" name="action">Submit
					<i class="material-icons right">send</i>
				</button>
			</p>
		</form>

		{% if filenames %}
		<div style="height: 200px; width: 1200px; border: 1px solid #ccc; font: 16px/26px Georgia, Garamond, Serif; overflow: auto;">
			<table style="width: auto; table-layout: auto; border-collapse: collapse;">
				<tr>
					{% for filename in filenames %}
						<td style="padding-left: 10px; padding-right: 10px; border: none; text-align: center;">
							<form method="POST" action="{{ url_for('diagnose') }}">
								<input type="hidden" name="to_get_img_index" data-index="{{ loop.index - 1 }}">
								<button name="detail_of_case" type="submit" value="{{ loop.index - 1 }}" onclick="adjustReset()" style="padding: 0; border: none; background: none;">
									<img class="clicked_image" src="../static/uploads/origin/{{ filename }}" width="128" height="128" style="display: block;">
								</button>
							</form> 
							<div>{{ filename }}</div>
						</td>
					{% endfor %}
				</tr>
			</table>
		</div>
		{% endif %}

		{% if data_to_show == True: %}
			<div class="flex-container">
				<!-- Canvas Container -->
				<div id="canvas-container">
					<img id="sourceImage" src="../static/uploads/origin/{{filenames[img_index]}}" width="512" height="512" style="display: block;" />
					<canvas id="myCanvas" width="512" height="512"></canvas>
				</div>
				
				<!-- Canvas Options Buttons -->
				<div class="options-container">
					<label for="options">病変を選択:</label>
					<div class="input-field col s12">
						<select id="options" name="options" onchange="change_anntotaion_type()">
							<option value="0">Fold</option>
							<option value="1">Corpus</option>
							<option value="2">Antrum</option>
						</select>
					</div>
					<button id="drawing-toggle" style="display: block; width:150px; height: 50px;">Disabling Drawing</button>
					<button id="zoom-button" style="display: block; width:150px; height: 50px;">Disabling Zoom</button>
					<button id="undo" style="display: block; width:150px; height: 50px;">Undo</button>
					
					
					<label for="window_level">Window Level:</label>
					<input type="range" id="window_level" min="1" max="4096" value="2048" onchange="updateImage()">
			
					<label for="window_width">Window Width:</label>
					<input type="range" id="window_width" min="1" max="4096" value="4096" onchange="updateImage()">
				</div>
			
				<div>
					<table class ="checklist" style="height: 500px;width: 500px; margin: 5px;">
						<tr>
							  <td>前庭部胃粘膜の判定
								<ul>
									<label><input type="checkbox" name="zentei_inen{{filenames[img_index]}}_1"> <span>平滑型</span></label>
									<label><input type="checkbox" name="zentei_inen{{filenames[img_index]}}_2"> <span>粗造型</span></label>
									<label><input type="checkbox" name="zentei_inen{{filenames[img_index]}}_3"> <span>中間型</span></label>
								</ul>
							</td>
							<td>胃体部胃粘膜の判定
								<ul>
									<label><input type="checkbox" name="itai_inen{{filenames[img_index]}}_1"> <span>平滑型</span></label>
									<label><input type="checkbox" name="itai_inen{{filenames[img_index]}}_2"> <span>粗造型</span></label>
									<label><input type="checkbox" name="itai_inen{{filenames[img_index]}}_3"> <span>中間型</span></label>
								</ul>
							</td>
							<td>ひだの形状判定
								<ul>
									<label><input type="checkbox" name="hida{{filenames[img_index]}}_1"> <span>正常型(6S)</span></label>
									<label><input type="checkbox" name="hida{{filenames[img_index]}}_1"> <span>異常型(非6S)</span></label>
									<label><input type="checkbox" name="hida{{filenames[img_index]}}_1"> <span>中間型</span></label>
									<label><input type="checkbox" name="hida{{filenames[img_index]}}_1"> <span>消失型</span></label>
								</ul>
							</td>
						</tr>
						<tr>
							<td>ひだの分布の判定
								<ul>
									<label><input type="checkbox" name="hida_bunpu{{filenames[img_index]}}_1"> <span>萎縮なし</span></label>
									<label><input type="checkbox" name="hida_bunpu{{filenames[img_index]}}_2"> <span>軽度萎縮</span></label>
									<label><input type="checkbox" name="hida_bunpu{{filenames[img_index]}}_3"> <span>中等度萎縮</span></label>
									<label><input type="checkbox" name="hida_bunpu{{filenames[img_index]}}_4"> <span>高度萎縮</span></label>
								</ul>
							</td>
							<td>読影(感染有無)
								<ul>
									<label><input type="checkbox" name="dokuei{{filenames[img_index]}}_1"> <span>非感染</span></label>
									<label><input type="checkbox" name="dokuei{{filenames[img_index]}}_2"> <span>感染</span></label>
								</ul>
							</td>
							<td>ABCD分類
								<ul>
									<label><input type="checkbox" name="ABCD{{filenames[img_index]}}_1"> <span>A(PG-,Anti-)</span></label>\
									<label><input type="checkbox" name="ABCD{{filenames[img_index]}}_2"> <span>B(PG-,Anti+)</span></label>
									<label><input type="checkbox" name="ABCD{{filenames[img_index]}}_3"> <span>C(PG+,Anti+)</span></label>
									<label><input type="checkbox" name="ABCD{{filenames[img_index]}}_4"> <span>D(PG+,Anti-)</span></label>
									<label><input type="checkbox" name="ABCD{{filenames[img_index]}}_5"> <span>その他</span></label>
								</ul>
							</td>
						</tr>
						<tr>
							<th>
								<form method="POST" action="{{ url_for('diagnose_result') }}">
									<input type="hidden" name="img_index" value="{{img_index}}">
									<button name="ai_result" type="submit" value="{{filename}}">
										Show AI diagnose result
									</button>
								</form> 									
							</th>
						</tr>
					</table>
				</div>

				{% if show_result == True: %}
				<!-- Heatmap Display -->
				<div class="image-container">
					<img class="img" src="../static/uploads/origin/{{filenames[img_index]}}" width="512" height="512" />
					<img class="img_top" src="../static/uploads/heatmap/{{filenames[img_index]}}" width="512" height="512" />
				</div>
				
				<table>
					<tr>
						
						<td>
							<p>感染する確率 : {{prediction[img_index]}}%</p>
							<br>
							<p>診断結果 : {{results[img_index]}}</p>
							<br>
							<a href="{{ url_for('.download_file') }}">Download heatmaps</a>
						</td>
					</tr>
				</table>
				{% endif %}
			</div>
			
		{% endif %}
	</body>
</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- To use node JS to save checkbox state-->
<script src="http://code.jquery.com/jquery.js"></script>
<!-- This JavaScript file is required to load the XpressDox interview as well as the code required to run it -->

<script src="../static/js/CheckboxState.js"></script>

<script src="../static/js/DrawingScript.js"></script>

<script src="../static/js/ImageViewer.js"></script>

<script src="../static/js/globalState.js"></script>

<script>
	//script to handle slider to change opacity
	var range = document.getElementById("range");
	var imgTop = document.getElementsByClassName("img_top")[0];

	range.addEventListener("input", function() {
    	imgTop.style.opacity = this.value / this.max;
	});
</script>

<script src="../static/js/updateImage.js"></script>

<script>
//script to use dropdown menu while using materializeCSS
document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('select');
    var instances = M.FormSelect.init(elems, options);
  });

  // Or with jQuery

  $(document).ready(function(){
    $('select').formSelect();
  });
</script>

       